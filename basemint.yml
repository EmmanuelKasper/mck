    - name: download mint {{ version }} distribution
      get_url:
        url: "https://bintray.com/freemint/freemint/download_file?file_path=snapshots%2F{{ major_version }}-{{ commit_hash }}%2Ffreemint-{{ major_version }}-{{ minor_version }}-000-st_ste.zip"
        dest: "{{ playbook_dir }}/freemint-{{ version }}-000-st_ste.zip"
        force: no

    - name: create folder structure
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - freemint
        - build/auto
        - build/extra
        - resources/etherne/
        - resources/coreutils

    - name: unpack freemint archive
      unarchive:
        src: freemint-{{ version }}-000-st_ste.zip
        dest: freemint
        creates: freemint/auto/mint-{{ minor_version }}.prg

    - name: copy freemint kernel
      copy:
        src: freemint/auto/mint-{{ minor_version }}.prg
        dest: build/auto/mint-{{ minor_version }}.prg

    - name : copy freemint sysdir
      command: cp -r freemint/mint build/
      args:
        creates: build/mint

    - name: remove default hostname
      replace:
        path: build/mint/{{ version }}/mint.cnf
        regexp : '^setenv HOSTNAME saturn$'
        replace: 'setenv HOSTNAME stmint'

    - name: set kernel debug level to alert
      replace:
        path: build/mint/{{ version }}/mint.cnf
        regexp : '^#KERN_DEBUG_LEVEL=1$'
        replace: 'KERN_DEBUG_LEVEL=1'

    - name: disable unused drivers
      command: mv build/mint/{{ version }}/{{ item }}.xfs build/mint/{{ version }}/{{ item }}.xfx
      args:
        creates: build/mint/{{ version }}/{{ item }}.xfx
      loop:
        - ext2
        - nfs

    - name: copy sash sell
      copy:
        src: sash-3.8/sash
        dest: build/mint/{{ version }}/sys-root/bin

    - name: set sash as the default root shell
      copy:
        dest: build/mint/{{ version }}/sys-root/etc/passwd
        content: |
          root:x:0:0::/root:/bin/sash


    - name: create defaults directory
      file:
        path: build/mint/{{ version }}/sys-root/root/defaults
        state: directory

    - name: use all builtins by default, and set a root prompt
      copy:
        dest: build/mint/{{ version }}/sys-root/root/defaults/sash.cfg
        content: |
          aliasall
          prompt #


    - name: download GNU coreutils for FreeMiNT
      get_url:
        url: http://vincent.riviere.free.fr/soft/m68k-atari-mint/archives/mint/coreutils/coreutils-8.21-mint-20131205-bin-mint-20131219.tar.bz2
        dest: resources/coreutils-8.21-mint-20131205-bin-mint-20131219.tar.bz2
        force: no

    # ignore warning to use the unarchive module, as it fails with
    # 'failed to find handler for 5380204-142837785679065/source'
    - name: untar coreutils
      command: >
        tar -C build/mint/{{ version }}/sys-root/
          -xaf resources/coreutils-8.21-mint-20131205-bin-mint-20131219.tar.bz2
        usr/bin
      args:
        creates: build/mint/{{ version }}/sys-root/usr/bin/uname
        warn: false

    - name: create a symlink for having the coreutils in /usr/bin
      replace:
        path: build/mint/{{ version }}/mint.cnf
        regexp : '^#sln e:/usr      u:/usr$'
        replace: 'sln c:/mint/1-19-4d2/sys-root/usr      u:/usr'

    - name: download ethernec driver
      get_url:
        url: http://web222.webclient5.de/prj/atari/download/etherne.zip
        dest: resources/etherne.zip
        force: no

    - name: unarchive ethernec driver
      unarchive:
        src: resources/etherne.zip
        dest: resources/etherne/
        creates: resources/etherne/ENEC.MIF

    - name: fix ethernet driver file permissions
      file:
        path: resources/etherne/ENEC.MIF
        mode: '0644'

    - name: copy ethernec driver to mint folder but leaves it disabled
      command: cp resources/etherne/ENEC.MIF build/mint/{{ version }}/enec.xix
      args:
        creates: build/mint/{{ version }}/enec.xix
